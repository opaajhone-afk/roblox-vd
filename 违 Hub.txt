if _G.loading then return end
_G.loading = true

-- åŸºç¡€æœåŠ¡
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StatsService = game:GetService("Stats")

-- æ¬¢è¿è„šæœ¬é…ç½®
local WELCOME_DB_URL = "https://zmgyquxrwewbhwgidkjo.supabase.co/rest/v1/player_roles"
local WELCOME_DB_KEY = "sb_publishable_x0N_UMWmYTclQH-yxWdjNA_z3HqtdYl"

local welcomeMessages = {
    author = "âœ¨ æ¬¢è¿è¿Hubè„šæœ¬ä½œè€…è¿é€† {username} åŠ å…¥æ¸¸æˆï¼",
    helper = "ğŸ”§ æ¬¢è¿è¿Hubè„šæœ¬ååŠ©è€… {username} åŠ å…¥æ¸¸æˆï¼",
    donator = "ğŸ’ æ¬¢è¿è¿HubèµåŠ©è€… {username} åŠ å…¥æ¸¸æˆï¼"
}

local playerRoles = {}
local welcomeSent = {}
local welcomeEnabled = true -- é»˜è®¤å¯ç”¨æ¬¢è¿åŠŸèƒ½

-- ä»æ•°æ®åº“è·å–è§’è‰²æ•°æ®
local function fetchPlayerRoles()
    local request = {
        Url = WELCOME_DB_URL,
        Method = "GET",
        Headers = {
            ["apikey"] = WELCOME_DB_KEY,
            ["Authorization"] = "Bearer " .. WELCOME_DB_KEY
        }
    }
    
    local success, response = pcall(function()
        return HttpService:RequestAsync(request)
    end)
    
    if success and response.StatusCode == 200 then
        local data = HttpService:JSONDecode(response.Body)
        playerRoles = {} -- æ¸…ç©ºæ—§æ•°æ®
        for _, item in ipairs(data) do
            if item.username and item.role then
                playerRoles[item.username] = item.role
            end
        end
        return true
    end
    return false
end

-- å‘é€æ¬¢è¿æ¶ˆæ¯
local function sendWelcomeMessage(player)
    -- ä¸æ¬¢è¿è‡ªå·±
    if player == LocalPlayer then return end
    
    if not player or welcomeSent[player.Name] then return end
    if not welcomeEnabled then return end
    
    local role = playerRoles[player.Name]
    if not role then return end
    
    local msgTemplate = welcomeMessages[role]
    if not msgTemplate then return end
    
    local message = msgTemplate:gsub("{username}", player.Name)
    
    local success = pcall(function()
        TextChatService.TextChannels.RBXGeneral:SendAsync(message)
    end)
    
    if success then
        welcomeSent[player.Name] = true
    end
    
    return success
end

-- é€šç”¨æ¶ˆæ¯å‘é€å‡½æ•°
local function sendSpecifiedMessage(message)
    local success, err = pcall(function()
        TextChatService.TextChannels.RBXGeneral:SendAsync(message)
        return true
    end)
    
    if not success then
        success = pcall(function()
            LocalPlayer.Chatted:Fire(message)
            return true
        )
    end
    
    return success
end

-- æ€§èƒ½ç»Ÿè®¡UI
local performanceStatsUI = nil
local renderSteppedConn = nil

local function createPerformanceStats()
    if performanceStatsUI then
        performanceStatsUI:Destroy()
    end
    if renderSteppedConn then
        renderSteppedConn:Disconnect()
    end

    local player = game.Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PerformanceStats"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = playerGui
    
    local dragFrame = Instance.new("Frame")
    dragFrame.Name = "DragFrame"
    dragFrame.Size = UDim2.new(0, 120, 0, 32)
    dragFrame.Position = UDim2.new(1, -130, 0, 10)
    dragFrame.BackgroundTransparency = 1
    dragFrame.Active = true
    dragFrame.Selectable = false
    dragFrame.Parent = screenGui
    
    local fpsLabel = Instance.new("TextLabel")
    fpsLabel.Name = "FPSLabel"
    fpsLabel.Size = UDim2.new(1, 0, 0, 16)
    fpsLabel.Position = UDim2.new(0, 0, 0, 0)
    fpsLabel.BackgroundTransparency = 1
    fpsLabel.Text = "FPS: --"
    fpsLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    fpsLabel.TextSize = 14
    fpsLabel.Font = Enum.Font.Code
    fpsLabel.TextXAlignment = Enum.TextXAlignment.Right
    fpsLabel.TextStrokeTransparency = 0.7
    fpsLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    fpsLabel.Parent = dragFrame
    
    local pingLabel = Instance.new("TextLabel")
    pingLabel.Name = "PingLabel"
    pingLabel.Size = UDim2.new(1, 0, 0, 16)
    pingLabel.Position = UDim2.new(0, 0, 0, 16)
    pingLabel.BackgroundTransparency = 1
    pingLabel.Text = "Ping: --"
    pingLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    pingLabel.TextSize = 14
    pingLabel.Font = Enum.Font.Code
    pingLabel.TextXAlignment = Enum.TextXAlignment.Right
    pingLabel.TextStrokeTransparency = 0.7
    pingLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    pingLabel.Parent = dragFrame
    
    local dragging = false
    local dragInput
    local dragStart
    local startPos
    
    local function updateInput(input)
        local delta = input.Position - dragStart
        dragFrame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
    
    dragFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = dragFrame.Position
            
            dragFrame.BackgroundTransparency = 0.8
            dragFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            dragFrame.BorderSizePixel = 1
            dragFrame.BorderColor3 = Color3.fromRGB(100, 100, 100)
            
            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    dragFrame.BackgroundTransparency = 1
                    dragFrame.BorderSizePixel = 0
                    connection:Disconnect()
                end
            end)
        end
    end)
    
    dragFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            updateInput(input)
        end
    end)
    
    local function getNetworkStats()
        local ping = 0
        pcall(function()
            local network = StatsService.Network
            if network and network.ServerStatsItem then
                local dataPing = network.ServerStatsItem["Data Ping"]
                if dataPing then
                    ping = math.floor(dataPing:GetValue())
                end
            end
        end)
        return ping
    end
    
    local fps = 0
    local frameCount = 0
    local lastTime = 0
    
    dragFrame.MouseEnter:Connect(function()
        fpsLabel.TextStrokeTransparency = 0.4
        pingLabel.TextStrokeTransparency = 0.4
    end)
    
    dragFrame.MouseLeave:Connect(function()
        if not dragging then
            fpsLabel.TextStrokeTransparency = 0.7
            pingLabel.TextStrokeTransparency = 0.7
        end
    end)
    
    renderSteppedConn = RunService.RenderStepped:Connect(function(deltaTime)
        frameCount = frameCount + 1
        
        local currentTime = tick()
        if currentTime - lastTime >= 0.5 then
            fps = math.floor(frameCount / (currentTime - lastTime))
            frameCount = 0
            lastTime = currentTime
            
            local ping = getNetworkStats()
            
            local fpsColor = Color3.fromRGB(255, 255, 255)
            local pingColor = Color3.fromRGB(255, 255, 255)
            
            if fps < 30 then
                fpsColor = Color3.fromRGB(255, 50, 50)
            elseif fps < 60 then
                fpsColor = Color3.fromRGB(255, 200, 50)
            else
                fpsColor = Color3.fromRGB(50, 255, 50)
            end
            
            if ping > 200 then
                pingColor = Color3.fromRGB(255, 50, 50)
            elseif ping > 100 then
                pingColor = Color3.fromRGB(255, 200, 50)
            else
                pingColor = Color3.fromRGB(50, 255, 50)
            end
            
            fpsLabel.Text = string.format("FPS: %d", fps)
            fpsLabel.TextColor3 = fpsColor
            
            pingLabel.Text = string.format("Ping: %d", ping)
            pingLabel.TextColor3 = pingColor
        end
    end)
    
    player.CharacterAdded:Connect(function()
        if not screenGui.Parent then
            screenGui.Parent = playerGui
        end
    end)
    
    dragFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            dragFrame.Position = UDim2.new(1, -130, 0, 10)
        end
    end)
    
    performanceStatsUI = screenGui
    return screenGui
end

-- ä¸»ç•Œé¢
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "LoaderUI"
ScreenGui.Parent = PlayerGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 300, 0, 350) -- é«˜åº¦å¢åŠ ä»¥å®¹çº³æ›´å¤šé€‰é¡¹
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -175)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BackgroundTransparency = 0.3
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainFrame

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, 0, 0, 50)
TitleLabel.Position = UDim2.new(0, 0, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "è¿ Hub"
TitleLabel.Font = Enum.Font.SourceSansBold
TitleLabel.TextSize = 22
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextXAlignment = Enum.TextXAlignment.Center
TitleLabel.TextYAlignment = Enum.TextYAlignment.Center
TitleLabel.Parent = MainFrame

local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Size = UDim2.new(1, -20, 0, 180)
ScrollFrame.Position = UDim2.new(0, 10, 0, 60)
ScrollFrame.BackgroundTransparency = 1
ScrollFrame.ScrollBarThickness = 4
ScrollFrame.ScrollBarImageColor3 = Color3.fromRGB(200, 200, 200)
ScrollFrame.CanvasSize = UDim2.new(1, 0, 0, 200)
ScrollFrame.Parent = MainFrame

local NoticeLabel = Instance.new("TextLabel")
NoticeLabel.Size = UDim2.new(1, 0, 0, 200)
NoticeLabel.BackgroundTransparency = 1
NoticeLabel.Text = "æ¬¢è¿ä½¿ç”¨è¿ Hub\n\né€‚é…æœåŠ¡å™¨: è‡ªç„¶ç¾å®³, æš´åŠ›åŒº\n\nåŠŸèƒ½è¯´æ˜:\nâ€¢ è‡ªåŠ¨æ¬¢è¿ç‰¹æ®Šç©å®¶\nâ€¢ å®æ—¶æ€§èƒ½ç›‘æ§\nâ€¢ æ¸¸æˆç‰¹å®šè„šæœ¬\n\næˆ‘ä»¬ä¼šä¸æ–­æ”¹è¿›è„šæœ¬,ä»¥ä¾¿ç”¨æˆ·è·å¾—æœ€ä½³ä½“éªŒ"
NoticeLabel.Font = Enum.Font.SourceSans
NoticeLabel.TextSize = 16
NoticeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
NoticeLabel.TextXAlignment = Enum.TextXAlignment.Center
NoticeLabel.TextYAlignment = Enum.TextYAlignment.Top
NoticeLabel.TextWrapped = true
NoticeLabel.Parent = ScrollFrame

-- å‘é€æ¬¢è¿æ¶ˆæ¯å¼€å…³
local WelcomeToggle = Instance.new("TextButton")
WelcomeToggle.Size = UDim2.new(0, 20, 0, 20)
WelcomeToggle.Position = UDim2.new(0.5, -110, 1, -115)
WelcomeToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
WelcomeToggle.BackgroundTransparency = 0.3
WelcomeToggle.Text = "âˆš"
WelcomeToggle.Font = Enum.Font.SourceSansBold
WelcomeToggle.TextSize = 14
WelcomeToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
WelcomeToggle.TextXAlignment = Enum.TextXAlignment.Center
WelcomeToggle.TextYAlignment = Enum.TextYAlignment.Center
WelcomeToggle.Parent = MainFrame

local ToggleCorner1 = Instance.new("UICorner")
ToggleCorner1.CornerRadius = UDim.new(0, 4)
ToggleCorner1.Parent = WelcomeToggle

local WelcomeLabel = Instance.new("TextLabel")
WelcomeLabel.Size = UDim2.new(0, 180, 0, 20)
WelcomeLabel.Position = UDim2.new(0.5, -90, 1, -115)
WelcomeLabel.BackgroundTransparency = 1
WelcomeLabel.Text = "å¯ç”¨ç©å®¶æ¬¢è¿"
WelcomeLabel.Font = Enum.Font.SourceSans
WelcomeLabel.TextSize = 14
WelcomeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
WelcomeLabel.TextXAlignment = Enum.TextXAlignment.Left
WelcomeLabel.Parent = MainFrame

WelcomeToggle.MouseButton1Click:Connect(function()
    welcomeEnabled = not welcomeEnabled
    WelcomeToggle.Text = welcomeEnabled and "âˆš" or "Ã—"
    WelcomeToggle.BackgroundColor3 = welcomeEnabled and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(80, 20, 20)
end)

-- å‘é€è¿›å…¥æ¶ˆæ¯å¼€å…³
local EnterToggle = Instance.new("TextButton")
EnterToggle.Size = UDim2.new(0, 20, 0, 20)
EnterToggle.Position = UDim2.new(0.5, -110, 1, -90)
EnterToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
EnterToggle.BackgroundTransparency = 0.3
EnterToggle.Text = "âˆš"
EnterToggle.Font = Enum.Font.SourceSansBold
EnterToggle.TextSize = 14
EnterToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
EnterToggle.TextXAlignment = Enum.TextXAlignment.Center
EnterToggle.TextYAlignment = Enum.TextYAlignment.Center
EnterToggle.Parent = MainFrame

local ToggleCorner2 = Instance.new("UICorner")
ToggleCorner2.CornerRadius = UDim.new(0, 4)
ToggleCorner2.Parent = EnterToggle

local EnterLabel = Instance.new("TextLabel")
EnterLabel.Size = UDim2.new(0, 180, 0, 20)
EnterLabel.Position = UDim2.new(0.5, -90, 1, -90)
EnterLabel.BackgroundTransparency = 1
EnterLabel.Text = "å‘é€è¿›å…¥æ¶ˆæ¯"
EnterLabel.Font = Enum.Font.SourceSans
EnterLabel.TextSize = 14
EnterLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
EnterLabel.TextXAlignment = Enum.TextXAlignment.Left
EnterLabel.Parent = MainFrame

local enterMessageEnabled = true
EnterToggle.MouseButton1Click:Connect(function()
    enterMessageEnabled = not enterMessageEnabled
    EnterToggle.Text = enterMessageEnabled and "âˆš" or "Ã—"
    EnterToggle.BackgroundColor3 = enterMessageEnabled and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(80, 20, 20)
end)

-- æ€§èƒ½ç›‘æ§å¼€å…³
local PerformanceToggle = Instance.new("TextButton")
PerformanceToggle.Size = UDim2.new(0, 20, 0, 20)
PerformanceToggle.Position = UDim2.new(0.5, -110, 1, -65)
PerformanceToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
PerformanceToggle.BackgroundTransparency = 0.3
PerformanceToggle.Text = "âˆš"
PerformanceToggle.Font = Enum.Font.SourceSansBold
PerformanceToggle.TextSize = 14
PerformanceToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
PerformanceToggle.TextXAlignment = Enum.TextXAlignment.Center
PerformanceToggle.TextYAlignment = Enum.TextYAlignment.Center
PerformanceToggle.Parent = MainFrame

local ToggleCorner3 = Instance.new("UICorner")
ToggleCorner3.CornerRadius = UDim.new(0, 4)
ToggleCorner3.Parent = PerformanceToggle

local PerformanceLabel = Instance.new("TextLabel")
PerformanceLabel.Size = UDim2.new(0, 180, 0, 20)
PerformanceLabel.Position = UDim2.new(0.5, -90, 1, -65)
PerformanceLabel.BackgroundTransparency = 1
PerformanceLabel.Text = "æ˜¾ç¤ºæ€§èƒ½ç›‘æ§"
PerformanceLabel.Font = Enum.Font.SourceSans
PerformanceLabel.TextSize = 14
PerformanceLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
PerformanceLabel.TextXAlignment = Enum.TextXAlignment.Left
PerformanceLabel.Parent = MainFrame

PerformanceToggle.MouseButton1Click:Connect(function()
    if performanceStatsUI then
        performanceStatsUI.Enabled = not performanceStatsUI.Enabled
        PerformanceToggle.Text = performanceStatsUI.Enabled and "âˆš" or "Ã—"
        PerformanceToggle.BackgroundColor3 = performanceStatsUI.Enabled and Color3.fromRGB(60, 60, 60) or Color3.fromRGB(80, 20, 20)
    end
end)

local StartButton = Instance.new("TextButton")
StartButton.Size = UDim2.new(0, 120, 0, 30)
StartButton.Position = UDim2.new(0.5, -60, 1, -35)
StartButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
StartButton.BackgroundTransparency = 0.3
StartButton.Text = "å¼€å§‹ä½¿ç”¨"
StartButton.Font = Enum.Font.SourceSansBold
StartButton.TextSize = 18
StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StartButton.TextXAlignment = Enum.TextXAlignment.Center
StartButton.TextYAlignment = Enum.TextYAlignment.Center
StartButton.Parent = MainFrame

local ButtonUICorner = Instance.new("UICorner")
ButtonUICorner.CornerRadius = UDim.new(0, 8)
ButtonUICorner.Parent = StartButton

-- ä¸»å¯åŠ¨å‡½æ•°
StartButton.MouseButton1Click:Connect(function()
    -- åˆå§‹åŒ–æ¬¢è¿ç³»ç»Ÿ
    print("æ­£åœ¨åˆå§‹åŒ–æ¬¢è¿ç³»ç»Ÿ...")
    local welcomeLoaded = fetchPlayerRoles()
    if welcomeLoaded then
        print("ç©å®¶è§’è‰²æ•°æ®åŠ è½½æˆåŠŸ")
    else
        print("è­¦å‘Š: æ— æ³•åŠ è½½ç©å®¶è§’è‰²æ•°æ®")
    end
    
    -- ä¸ºå½“å‰ç©å®¶å‘é€æ¬¢è¿æ¶ˆæ¯
    for _, player in ipairs(Players:GetPlayers()) do
        sendWelcomeMessage(player)
    end
    
    -- ç›‘å¬æ–°ç©å®¶åŠ å…¥
    Players.PlayerAdded:Connect(function(player)
        sendWelcomeMessage(player)
    end)
    
    -- å®šæœŸæ›´æ–°è§’è‰²æ•°æ®
    spawn(function()
        while true do
            wait(300)
            fetchPlayerRoles()
        end
    end)
    
    -- åŠ è½½æ¸¸æˆç‰¹å®šè„šæœ¬
    local scripts = {
        [189707] = "https://raw.githubusercontent.com/opaajhone-afk/roblox-vd/main/è‡ªç„¶ç¾å®³.lua",
        [93978595733734] = "https://raw.githubusercontent.com/opaajhone-afk/roblox-vd/main/æš´åŠ›åŒº.lua",
    }

    local gameId = game.PlaceId
    if scripts[gameId] then
        print("æ­£åœ¨ä¸ºæ¸¸æˆID "..gameId.." åŠ è½½è„šæœ¬...")
        local success, content = pcall(function()
            return game:HttpGet(scripts[gameId])
        end)
        if success and content then
            local func = loadstring(content)
            if func then
                -- å…³é—­ä¸»ç•Œé¢
                MainFrame:Destroy()
                ScreenGui:Destroy()
                
                -- æ‰§è¡Œæ¸¸æˆè„šæœ¬
                func()
                print("è„šæœ¬åŠ è½½æˆåŠŸ")
                
                -- å‘é€è¿›å…¥æ¶ˆæ¯
                if enterMessageEnabled then
                    local chatSuccess = sendSpecifiedMessage("æ¬¢è¿è¿ Hubä½¿ç”¨è€…è¿›å…¥æ¸¸æˆ")
                    if chatSuccess then
                        print("æŒ‡å®šæ¶ˆæ¯å·²å‘é€")
                    else
                        print("æ¶ˆæ¯å‘é€å¤±è´¥")
                    end
                end
            else
                print("è„šæœ¬è§£æå¤±è´¥")
            end
        else
            print("è„šæœ¬ä¸‹è½½å¤±è´¥")
        end
    else
        warn("æœªé€‚é…æ­¤æ¸¸æˆ")
        MainFrame:Destroy()
        ScreenGui:Destroy()
        LocalPlayer:Kick("æœªé€‚é…æ­¤æ¸¸æˆ")
    end
    _G.loading = false
end)

-- åˆ›å»ºæ€§èƒ½ç›‘æ§
performanceStatsUI = createPerformanceStats()